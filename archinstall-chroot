#!/usr/bin/env sh

echo "LANG=en_GB.UTF-8" >> /etc/locale.conf
sed -i -e 's/#tr_TR.UTF/tr_TR.UTF/' -e 's/#en_GB.UTF/en_GB.UTF/' /etc/locale.gen
locale-gen

mkdir /boot/EFI
mount "/dev/$1" /boot/EFI

grub-install --target=x86_64-efi --bootloader-id=grub-uefi --recheck
mkdir -p /boot/grub/locale
cp /usr/share/locale/en\@quot/LC_MESSAGES/grub.mo /boot/grub/locale/en.mo
grub-mkconfig -o /boot/grub/grub.cfg

mem="$( free -m | grep Mem | awk '{print $2}' )"
(( mem += 1 ))
fallocate -l "$mem"M /swapfile
chmod 600 /swapfile
mkswap /swapfile

echo '/swapfile none swap sw 0 0' >> tee -a /etc/fstab

echo "root:$2" | chpasswd
useradd -m -g users -G wheel "$3"
echo "$3:$4" | chpasswd

timedatectl set-ntp true
hwclock --systohc

files="$( find root )"

for i in $files
do
    owner="$( stat -c "%U" "$i" )"
    [ "$( stat -c "%U" "$i" )" = "root" ] || chown "$3" "$i"
done

cp -r /root/* /
rm -r /root /archinstall-chroot

systemctl enable sshd
systemctl enable NetworkManager

exit 0
