#!/usr/bin/env sh
#
# Before executing, you must have mounted the formatted drives to /mnt.
# This includes the /boot/EFI, /home and others along /.
# You must also be connected to the internet.
#
# Example execution: ./archinstall 'nvme0n1p3' 'nvme0n1p5' 'sda6' '!WSVf6wS5Sj!_mq' 'xphyro' 'gWEGg124!!ggpqA' 'wpa' 'xphyro-2.4' '1k51345!25sddsgg5!' 'y'

willexit=0

[ "$( echo "$PWD" | sed 's/.*\///' )" = "archinstall" ] || { echo "This script must be run from the root folder of the repository."; willexit=1; }
[ "$6" = "" ] && { echo "You must call this script with at least 6 arguments: efi_partition, root_partition, home_partition, root_passwd, user, user_password."; printf "All arguments:\nefi_partition, root_partition, home_partition, root_passwd, user, user_password, wireless_security, wirelss_ssid, wireless_password, wireless_hidden\n"; willexit=1; }
if ! [ "$( curl -Is https://www.google.com | head -n 1 | awk '{print $2}' )" = "200" ]
then
    if [ "$7" ] && [ "$8" ] && [ "$9" ] && [ "${10}" ] 
    then
        printf "Description='A simple %s encrypted wireless connection'\nInterface=wlan0\nConnection=wireless\nSecurity=%s\nIP=dhcp\nESSID='%s'\nKey='%s'\n" "$7" "$7" "$8" "$9" > /etc/netctl/wirelessconf
        [ "${10}" = "y" ] && echo "Hidden=yes" >> /etc/netctl/wirelessconf

        netctl start /etc/netctl/wirelessconf || willexit=1
    else
        echo "You are not connected to the internet."
        willexit=1
    fi
fi

[ "$willexit" = "0" ] || exit "$willexit"

mkfs.fat -F32 "/dev/$1"
mkfs.ext4 "/dev/$2"
mkfs.ext4 "/dev/$3"

mkdir /mnt/home
mount "/dev/$2" /mnt
mount "/dev/$3" /mnt/home

pacman -Sy --noconfirm archlinux-keyring

pacstrap /mnt base base-devel grub efibootmgr dosfstools openssh os-prober mtools linux linux-firmware linux-headers linux-lts linux-lts-headers vim network-manager-applet networkmanager wireless_tools wpa_supplicant netctl dhcpcd dialog git xorg xorg-server xf86-video-intel libgl mesa nvidia nvidia-lts nvidia-libgl zsh pacman-contrib reflector chsh

genfstab -U /mnt >> /mnt/etc/fstab

cp -r archinstall-chroot root /mnt
arch-chroot /mnt /archinstall-chroot "$1" "$4" "$5" "$6" | tee archinstall-chroot.log

umount -a
reboot
